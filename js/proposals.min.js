function trim(a,b){var c,d=0,e=0;for(a+="",b?(b+="",c=b.replace(/([\[\]\(\)\.\?\/\*\{\}\+\$\^\:])/g,"$1")):c=" \n\r	\f            ​\u2028\u2029　",d=a.length,e=0;d>e;e++)if(-1===c.indexOf(a.charAt(e))){a=a.substring(e);break}for(d=a.length,e=d-1;e>=0;e--)if(-1===c.indexOf(a.charAt(e))){a=a.substring(0,e+1);break}return-1===c.indexOf(a.charAt(0))?a:""}function fillFaceboxFromIframe(a,b){$.facebox.reveal('<iframe scrolling="no" marginwidth="0" width="920" frameborder="0" src="'+a+'" marginheight="0"></iframe>',b)}function fixIframeHeight(){$("iframe").each(function(){var a=$(this).contents().find("#main > .row:nth(1)").height()+60;0!=$(".no-csstransitions").length?$("iframe").animate({height:a},200):$(this).height(a)})}function compareProposal(a,b){try{var c=!0;return $.each(a,function(a,d){"object"==typeof d?compareProposal(d,b[a])||(c=!1):d!=b[a]&&(c=!1)}),c}catch(d){return!1}}function getProposalFieldValue(a,b){var c=null;if(c=b?b.find("."+a):$("."+a),parseInt(c.data("estimate-id"))>0)return c.data("estimate-id");var d="";return 0!=c.find("textarea").length?d=0==c.find("textarea").parents(".section-contents").length?c.find("textarea").val().replace(/\n/g,"<br />\n"):c.find("textarea").val():c.hasClass("empty-stuffs")||(d=c.html()),null===d?"null":d}function getProposalObject(){var a={};return a.title=getProposalFieldValue("proposalTitle"),a.client_id=trim(getProposalFieldValue("clientId")),a.client_company=getProposalFieldValue("clientCompany"),a.client_address=getProposalFieldValue("clientAddress"),a.client_name=getProposalFieldValue("clientName"),a.sections=[],$("div.section:not(.sampleSection)").each(function(){var b={};b.page_key=$(this).parents(".page").data("key"),b.proposal_id=parseInt($(".proposalId").text()),b.key=$(this).data("key"),$(this).is(".subsection")?(b.parent_id=$(this).parents(".page").data("key")+"-"+$(this).parents(".section").data("key"),alert($(this).parents(".page").data("key")+"-"+$(this).parents(".section").data("key"))):b.parent_id=0,b.title=getProposalFieldValue("section-title",$(this)),b.subtitle=getProposalFieldValue("section-subtitle",$(this)),b.contents=getProposalFieldValue("section-contents",$(this)),b.section_type=$(this).data("type")?$(this).data("type"):"section",a.sections.push(b)}),a}function hideSaving(a){var b=$(a).data("currentlySaving")?$(a).data("currentlySaving"):saving;b||($(a).html($(a).data("saved")).removeClass("saving").addClass("saved"),setTimeout(function(){$(a+".saved").html($(a).data("save")).removeClass("saved")},500))}function showSaving(a){setTimeout("hideSaving('"+a+"');",500),$(a).html($(a).data("saving")).addClass("saving")}function autosave(a){if(!saving&&(a||proposalAutosave)){saving=!0,showSaving(".saveProposal");var b=getProposalObject();$.post(proposalSaveUrl,b,function(a){hideSaving(".saveProposal"),saving=!1;var c="";try{c=JSON.parse(a)}catch(d){alert("There was an unknown problem storing your proposal. Please backup your proposal's information to avoid losing any.")}return"NOT_LOGGED_IN"==a?alert("You are not logged in to Pancake. Your proposal CANNOT be stored."):"UHOH"==a?alert("There was a problem storing your proposal in your database. Please wait and try again."):compareProposal(b,c)||alert("There was an unknown problem storing your proposal. Please backup your proposal's information to avoid losing any."),redirect?(window.location.href=redirect,void 0):void 0})}}function fixKeys(){$(".page:not(:last-child):not(.samplePage)").each(function(){0==$(this).find(".section").length&&$(this).remove()}),$(".sidebar, .pageContainer").each(function(){var a=1;$(this).find(".page:not(.samplePage)").each(function(){$(this).removeClass("page-"+$(this).data("key")).data("key",a).addClass("page-"+a).find(".pageCount").html(pagexofcount.replace(":1",a).replace(":2",'<span class="pageTotal">'+$(".sidebar .page").length+"</span>")),a++;var b=1;$(this).find(".section").each(function(){$(this).removeClass("section-"+$(this).data("key")).data("key",b).addClass("section-"+b),b++})})}),autosave()}function addDeleteSectionButtons(){$(".sidebar .section > span:not(.closed)").addClass("closed").prepend('<a class="close" href="">X</a>'),$(".sidebar .close").click(function(){var a=$(this).parents(".section").data("key"),b=$(this).parents(".page").data("key");return $(".page-"+b+" .section-"+a).remove(),fixKeys(),autosave(),!1})}function addSection(a,b,c,d,e,f){if(c=void 0==c?0:c,b=void 0==b?"section":b,e=void 0==e?"":e,f=void 0==f?"":f,d=void 0==d?"":d,!addingSection&&"estimate"==b)return addingSection=!0,$.get(proposalGetProcessedEstimate+"/"+c,function(d){addSection(a,b,c,d),addingSection=!1}),void 0;var g=a.data("key"),h=a.find(".section:last-child").data("key"),i=h?h+1:1,j=$(".sampleSection").clone().removeClass("sampleSection").data("key",i).addClass("section-"+i).hide();j.find(".section-title").html($(".proposal").data("empty-title")).addClass("empty-stuffs"),j.find(".section-subtitle").html($(".proposal").data("empty-subtitle")).addClass("empty-stuffs"),j.find(".section-contents").html($(".proposal").data("empty-contents")).addClass("empty-stuffs"),j.data("type",b),jQuery(document).trigger("close.facebox"),"section"!=b?j.find(".section-contents").removeClass("editable").addClass(b).data("estimate-id",c).removeClass("empty-stuffs").html(d):(""!=e&&j.find(".section-title").removeClass("empty-stuffs").html(e),""!=f&&j.find(".section-subtitle").removeClass("empty-stuffs").html(f),""!=d&&j.find(".section-contents").removeClass("empty-stuffs").html(d)),a.find(".sectionContainer").append(j.fadeIn());var k=$('<li class="section section-'+i+'" data-key="'+i+'"><span>'+j.find(".section-title").html()+"</span><ul></ul></li>").hide();$(".sidebar .page-"+g+" > ul").append(k.fadeIn()),makeSortable(),addDeleteSectionButtons(),fixKeys(),autosave()}function stopEditing(a){var b=$(".currentlyEditing textarea");if(b.length>0){try{ckeditor=b.ckeditorGet(),"string"!=typeof ckeditor&&ckeditor.destroy()}catch(c){}$(".editing-container").append($(".editing"));var d=b.data("old-value"),e=a?void 0==d?"":d:b.val(),f=""==e;if(f){var g=b.parent(),h="";h=g.hasClass("section-title")?$(".proposal").data("empty-title"):g.hasClass("section-subtitle")?$(".proposal").data("empty-subtitle"):$(".proposal").data("empty-contents"),g.html(h).addClass("empty-stuffs")}else e=0==b.parents(".section-contents").length?e.replace(/\n/g,"<br />\n"):e,b.parents(".editable").html(e);autosave(),$(".currentlyEditing").removeClass("currentlyEditing")}}function makeSortable(){$(".sidebar > ul > li > ul, .sidebar > ul > li > ul > li > ul").sortable("destroy"),$(".sidebar > ul > li > ul, .sidebar > ul > li > ul > li > ul").sortable({items:"> li",connectWith:$(".sidebar > ul > li > ul, .sidebar > ul > li > ul > li > ul"),dropOnEmpty:!0,placeholder:"empty",forcePlaceholderSize:!0,start:function(a,b){b.item.data("old-page",b.item.parents(".page").data("key"))},stop:function(a,b){var c=0!=b.item.parents(".section").length;if(c)return alert("subsection - process it; if it includes subsections of its own, remove them all and make them siblings; fix keys, process subsections in autosave(), and all that malarkey; rejecting drop for the time being"),!1;b.item.removeClass("subsection");var d=b.item.parents(".page").data("key"),e=b.item.data("key"),f=$(".proposal #wrapper .page-"+b.item.data("old-page")+" .section-"+e),g=b.item.prev().data("key");void 0==g?$(".proposal #wrapper .page-"+d+" .sectionContainer").prepend(f):$(".proposal #wrapper .page-"+d+" .section-"+g).after(f),fixKeys()}}),$(".sidebar > ul > li > ul, .sidebar > ul > li > ul > li > ul").disableSelection()}!function(a){function b(a){return"object"==typeof a?a:{top:a,left:a}}var c=a.scrollTo=function(b,c,d){a(window).scrollTo(b,c,d)};c.defaults={axis:"xy",duration:parseFloat(a.fn.jquery)>=1.3?0:1},c.window=function(){return a(window)._scrollable()},a.fn._scrollable=function(){return this.map(function(){var b=this,c=!b.nodeName||-1!=a.inArray(b.nodeName.toLowerCase(),["iframe","#document","html","body"]);if(!c)return b;var d=(b.contentWindow||b).document||b.ownerDocument||b;return a.browser.safari||"BackCompat"==d.compatMode?d.body:d.documentElement})},a.fn.scrollTo=function(d,e,f){return"object"==typeof e&&(f=e,e=0),"function"==typeof f&&(f={onAfter:f}),"max"==d&&(d=9e9),f=a.extend({},c.defaults,f),e=e||f.speed||f.duration,f.queue=f.queue&&f.axis.length>1,f.queue&&(e/=2),f.offset=b(f.offset),f.over=b(f.over),this._scrollable().each(function(){function g(a){j.animate(l,e,f.easing,a&&function(){a.call(this,d,f)})}var h,i=this,j=a(i),k=d,l={},m=j.is("html,body");switch(typeof k){case"number":case"string":if(/^([+-]=)?\d+(\.\d+)?(px|%)?$/.test(k)){k=b(k);break}k=a(k,this);case"object":(k.is||k.style)&&(h=(k=a(k)).offset())}a.each(f.axis.split(""),function(a,b){var d="x"==b?"Left":"Top",e=d.toLowerCase(),n="scroll"+d,o=i[n],p=c.max(i,b);if(h)l[n]=h[e]+(m?0:o-j.offset()[e]),f.margin&&(l[n]-=parseInt(k.css("margin"+d))||0,l[n]-=parseInt(k.css("border"+d+"Width"))||0),l[n]+=f.offset[e]||0,f.over[e]&&(l[n]+=k["x"==b?"width":"height"]()*f.over[e]);else{var q=k[e];l[n]=q.slice&&"%"==q.slice(-1)?parseFloat(q)/100*p:q}/^\d+$/.test(l[n])&&(l[n]=l[n]<=0?0:Math.min(l[n],p)),!a&&f.queue&&(o!=l[n]&&g(f.onAfterFirst),delete l[n])}),g(f.onAfter)}).end()},c.max=function(b,c){var d="x"==c?"Width":"Height",e="scroll"+d;if(!a(b).is("html,body"))return b[e]-a(b)[d.toLowerCase()]();var f="client"+d,g=b.ownerDocument.documentElement,h=b.ownerDocument.body;return Math.max(g[e],h[e])-Math.min(g[f],h[f])}}(jQuery),function(a){a.fn.TextAreaExpander=function(b,c){function d(a){a=a.target||a;var b=a.value.length,c=a.offsetWidth;if(b!=a.valLength||c!=a.boxWidth){e&&(b<a.valLength||c!=a.boxWidth)&&(a.style.height="0px");var d=Math.max(a.expandMin,Math.min(a.scrollHeight,a.expandMax));a.style.overflow=a.scrollHeight>d?"auto":"hidden",a.style.height=d+"px",a.valLength=b,a.boxWidth=c}return!0}var e=!(a.browser.msie||a.browser.opera);return this.each(function(){if("textarea"==this.nodeName.toLowerCase()){var e=this.className.match(/expand(\d+)\-*(\d+)*/i);this.expandMin=b||(e?parseInt("0"+e[1],10):0),this.expandMax=c||(e?parseInt("0"+e[2],10):99999),d(this),this.Initialized||(this.Initialized=!0,a(this).css("padding-top",0).css("padding-bottom",0),a(this).bind("keyup",d).bind("focus",d))}}),this}}(jQuery),window.Modernizr=function(a,b,c){function d(a,b){var c=a.charAt(0).toUpperCase()+a.substr(1),d=(a+" "+p.join(c+" ")+c).split(" ");return e(d,b)}function e(a,b){for(var d in a)if(o[a[d]]!==c)return"pfx"==b?a[d]:!0;return!1}function f(a,b){return typeof a===b}function g(a){o.cssText=a}var h,i,j,k="2.0.6",l={},m=(b.documentElement,b.head||b.getElementsByTagName("head")[0],"modernizr"),n=b.createElement(m),o=n.style,p=(Object.prototype.toString,"Webkit Moz O ms Khtml".split(" ")),q={},r=[],s={}.hasOwnProperty;j=f(s,c)||f(s.call,c)?function(a,b){return b in a&&f(a.constructor.prototype[b],c)}:function(a,b){return s.call(a,b)},q.csstransitions=function(){return d("transitionProperty")};for(var t in q)j(q,t)&&(i=t.toLowerCase(),l[i]=q[t](),r.push((l[i]?"":"no-")+i));return g(""),n=h=null,l._version=k,l._domPrefixes=p,l.testProp=function(a){return e([a])},l.testAllProps=d,l}(this,this.document),$("html").addClass(Modernizr.csstransitions?"csstransitions":"no-csstransitions"),setInterval(fixIframeHeight,100),saving=!1,redirect=!1;var addingSection=!1;$(".cover-page .editable").each(function(){""==$(this).html()&&$(this).addClass("empty-stuffs").html($(".proposal").data("empty-contents"))}),window.onbeforeunload=function(){return saving?"Your proposal is still being saved. If you don't want to lose any data, please stay on the page until the Save button says it's been saved.":void 0},$(".accept, .reject, .unanswer").click(function(){return $(this).hasClass("accept")?($(".accept, .reject").hide(),$(".accepted, .proposal.admin .unanswer").show(),$.get(proposalStatusUrl+"accept")):$(this).hasClass("reject")?($(".accept, .reject").hide(),$(".rejected, .proposal.admin .unanswer").show(),$.get(proposalStatusUrl+"reject")):($(".accept, .reject").show(),$(".accepted, .rejected, .unanswer").hide(),$.get(proposalStatusUrl)),!1}),$("body.proposal .toggle_is_viewable").click(function(){return $(this).hasClass("not-viewable")?($(this).html($(this).data("viewable")).removeClass("not-viewable").addClass("viewable"),$.get(proposalStatusUrl+"viewable")):($(this).html($(this).data("not-viewable")).removeClass("viewable").addClass("not-viewable"),$.get(proposalStatusUrl+"not_viewable")),!1}),$(".accepted, .rejected").click(function(){return!1}),$(".proposal.not-admin .sidebar .section").live("click",function(){var a=$(this).parents(".page").data("key"),b=$(this).data("key");$(".pageContainer .section").scrollTo($(".pageContainer .page-"+a+" .section-"+b))}),$(".proposal.admin").each(function(){$(".savePremadeSection").live("click",function(){var a=$(this).parents(".section"),b=$(this).parents(".page").data("key");return showSaving(".page-"+b+" .section-"+a.data("key")+" .savePremadeSection"),$(this).data("currentlySaving",!0),$.post(proposalSavePremadeSectionUrl,{title:getProposalFieldValue("section-title",a),subtitle:getProposalFieldValue("section-subtitle",a),contents:getProposalFieldValue("section-contents",a)},function(){hideSaving(".page-"+b+" .section-"+a.data("key")+" .savePremadeSection"),$(".page-"+b+" .section-"+a.data("key")+" .savePremadeSection").data("currentlySaving",!1)}),!1}),$(".addEstimate").live("click",function(){return addEstimatePage=$(this).parent(".page"),jQuery.facebox({ajax:proposalGetEstimates.replace("{UNIQID}",(new Date).getTime())}),$(document).bind("close.facebox",function(){addEstimatePage=null}),!1}),$(".addPremadeSection").live("click",function(){return addPremadeSectionPage=$(this).parent(".page"),jQuery.facebox({ajax:proposalGetPremadeSections}),$(document).bind("close.facebox",function(){addPremadeSectionPage=null}),!1}),$(".pickEstimate").live("click",function(){var a=$("#estimate-picker").val();return $(".estimate-selector").html($(".estimate-selector").data("inserting")),addSection(addEstimatePage,"estimate",a),!1}),$(".select-premade").live("click",function(){var a=$(this).parents(".premadeSection").data("premade-id"),b=$(".premade-contents.premade-"+a).html(),c=$(".premade-title.premade-"+a).html(),d=$(".premade-subtitle.premade-"+a).html();return addSection(addPremadeSectionPage,"section",0,b,c,d),!1}),$(".delete-premade").live("click",function(){$(this).parents(".premadeSection").data("premade-id"),$.get($(this).attr("href"));var a=$(this).parents(".premadeSection");return a.fadeOut(function(){a.remove()}),!1}),setInterval("autosave();",1e4),$("html").live("click",function(a){$(a.target).is("[class*=redactor], .editable, [class*=redactor] *, [id*=redactor], [id*=redactor] *")||stopEditing()}),$(".editing .confirm, .editing .cancel").live("click",function(a){return $(this).hasClass("confirm")?stopEditing():stopEditing(!0),a.stopPropagation(),!1}),$(".currentlyEditing *").live("click",function(a){a.stopPropagation()}),makeSortable(),addDeleteSectionButtons(),$(".saveProposal").click(function(){return autosave(!0),!1}),$(".addPage").click(function(){var a=$(".page:last-child").data("key")+1,b=$(".samplePage").clone().removeClass("samplePage").data("key",a).addClass("page-"+a).hide();$(".pageContainer").append(b.fadeIn()),pageCount=$(".pageContainer .page").length,$(".pageTotal").html(pageCount);var c=pagexofcount.replace(":1",a).replace(":2",'<span class="pageTotal">'+pageCount+"</span>"),d=$('<li class="page page-'+a+'" data-key="'+a+'"><span class="pageCount">'+c+"</span><ul></ul></li>").hide();return $(".sidebar > ul").append(d.fadeIn()),makeSortable(),autosave(),!1}),$(".addSection").live("click",function(){var a=$(this).parent(".page");return addSection(a),!1}),$(".editable").live("click",function(a){if(a.stopPropagation(),$(".editable textarea").length>0&&0==$(this).find("textarea").length&&stopEditing(),!$(this).hasClass("currentlyEditing")){$(this).addClass("currentlyEditing");var b="";$(this).hasClass("empty-stuffs")?$(this).removeClass("empty-stuffs"):b=$(this).hasClass("section-contents")?$(this).html():$(this).text(),$(this).html("<textarea>"+b+"</textarea>").find("textarea").data("old-value",b).focus(function(){$(this).select()}).focus(),$(this).append($(".editing")),$(".section-contents textarea:not(.wysiwyg)").addClass("wysiwyg").redactor(),$("textarea:not(.autoResizeable):not(.wysiwyg)").addClass("autoResizeable").TextAreaExpander(),$("textarea.autoResizeable").each(function(){$(this).val(),$(this).keydown()})}}),$(".section-title textarea").live("keyup",function(){var a=$(this).parents(".section"),b=a.data("key"),c=a.parents(".page").data("key"),d="";d=""!=$(this).val()?$(this).val():$(".proposal").data("empty-title"),$(".sidebar .page-"+c+" .section-"+b+" > span").removeClass("closed").html(d),addDeleteSectionButtons()}),$(".clientCompany textarea").live("keyup",function(){$(".clientCompany").each(function(){0==$(this).find("textarea").length&&(""!=$(".clientCompany textarea").val()?(val=$(".clientCompany textarea").val().replace(/\n/g,"<br />\n"),$(this).removeClass("empty-stuffs")):(val=$(".proposal").data("empty-contents"),$(this).addClass("empty-stuffs")),$(this).html(val))})}),$(".not-admin .sidebar .section").live("click",function(){$(".sectionContainer .section-"+$(this).data("key")).scrollTo()})});